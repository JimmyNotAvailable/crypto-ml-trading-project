{% extends "base.html" %}

{% block title %}Dashboard - Crypto ML{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üöÄ Crypto ML Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" onclick="tao_du_doan_moi()">
            <i class="fas fa-sync"></i> D·ª± ƒëo√°n M·ªõi
        </button>
    </div>
</div>

<!-- Cards t·ªïng quan -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card card-crypto">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">D·ª± ƒëo√°n M·ªõi nh·∫•t</h5>
                        {% if du_doan_hien_tai %}
                        <h3>${{ "%.2f"|format(du_doan_hien_tai.gia_du_doan) }}</h3>
                        <small>
                            {% if du_doan_hien_tai.thay_doi_phan_tram > 0 %}
                            <span class="badge bg-success">+{{ "%.2f"|format(du_doan_hien_tai.thay_doi_phan_tram) }}%</span>
                            {% else %}
                            <span class="badge bg-danger">{{ "%.2f"|format(du_doan_hien_tai.thay_doi_phan_tram) }}%</span>
                            {% endif %}
                        </small>
                        {% else %}
                        <h3>--</h3>
                        <small>Ch∆∞a c√≥ d·ªØ li·ªáu</small>
                        {% endif %}
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card card-ml">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">ƒê·ªô Tin c·∫≠y</h5>
                        {% if du_doan_hien_tai %}
                        <h3>{{ "%.1f"|format(du_doan_hien_tai.do_tin_cay * 100) }}%</h3>
                        <small>{{ du_doan_hien_tai.xu_huong }}</small>
                        {% else %}
                        <h3>--</h3>
                        <small>Ch∆∞a c√≥ d·ªØ li·ªáu</small>
                        {% endif %}
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-brain fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card card-trading">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Bot P&L</h5>
                        {% if hieu_suat_bot %}
                        <h3>
                            {% if hieu_suat_bot.roi_phan_tram > 0 %}
                            <span class="text-success">+{{ "%.2f"|format(hieu_suat_bot.roi_phan_tram) }}%</span>
                            {% else %}
                            <span class="text-danger">{{ "%.2f"|format(hieu_suat_bot.roi_phan_tram) }}%</span>
                            {% endif %}
                        </h3>
                        <small>${{ "%.2f"|format(hieu_suat_bot.so_du_hien_tai) }}</small>
                        {% else %}
                        <h3>--</h3>
                        <small>Bot ch∆∞a ho·∫°t ƒë·ªông</small>
                        {% endif %}
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-robot fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bi·ªÉu ƒë·ªì -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> D·ª± ƒëo√°n Gi√° Bitcoin</h5>
            </div>
            <div class="card-body">
                <div id="bieu_do_gia" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-thermometer-half"></i> ƒê·ªô Tin c·∫≠y</h5>
            </div>
            <div class="card-body">
                <div id="bieu_do_tin_cay" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- So s√°nh m√¥ h√¨nh -->
{% if so_sanh_mo_hinh %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-balance-scale"></i> So s√°nh Hi·ªáu su·∫•t M√¥ h√¨nh</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>M√¥ h√¨nh</th>
                                <th>Lo·∫°i</th>
                                <th>R¬≤ Score</th>
                                <th>MAE</th>
                                <th>RMSE</th>
                                <th>Th·ªùi gian Train (s)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ten, info in so_sanh_mo_hinh.items() %}
                            <tr>
                                <td><strong>{{ info.ten_hien_thi }}</strong></td>
                                <td><span class="badge bg-info">{{ info.loai }}</span></td>
                                <td>
                                    {% if info.metrics.r2 %}
                                    <span class="{% if info.metrics.r2 > 0.8 %}metric-positive{% elif info.metrics.r2 > 0.6 %}metric-neutral{% else %}metric-negative{% endif %}">
                                        {{ "%.3f"|format(info.metrics.r2) }}
                                    </span>
                                    {% else %}--{% endif %}
                                </td>
                                <td>
                                    {% if info.metrics.mae %}
                                    {{ "%.2f"|format(info.metrics.mae) }}
                                    {% else %}--{% endif %}
                                </td>
                                <td>
                                    {% if info.metrics.rmse %}
                                    {{ "%.2f"|format(info.metrics.rmse) }}
                                    {% else %}--{% endif %}
                                </td>
                                <td>{{ "%.2f"|format(info.thoi_gian_train) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Th√¥ng tin m√¥ h√¨nh v√† thao t√°c demo -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Th√¥ng tin M√¥ h√¨nh</h5>
                <div>
                    <a href="/model-info" class="btn btn-sm btn-outline-primary">M·ªü trang</a>
                    <button class="btn btn-sm btn-primary" onclick="tai_thong_tin_mo_hinh()">T·∫£i th√¥ng tin</button>
                </div>
            </div>
            <div class="card-body">
                <div id="model_info_content" class="small text-muted">Nh·∫•n "T·∫£i th√¥ng tin" ƒë·ªÉ xem m√¥ h√¨nh, ƒë·ªô ch√≠nh x√°c v√† metadata.</div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-bolt"></i> Thao t√°c Demo Nhanh</h5></div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-4">
                        <button class="btn btn-outline-secondary w-100" onclick="go_movers()">Movers 24h</button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-secondary w-100" onclick="go_price()">Gi√° BTC</button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-secondary w-100" onclick="go_chart()">Chart BTC</button>
                    </div>
                </div>
                <div id="demo_actions_output" class="mt-3 small text-muted"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function format_percent(x) {
    try { return (x*100).toFixed(1) + '%'; } catch { return String(x); }
}

function tao_du_doan_moi() {
    fetch('/api/du-doan-moi')
        .then(response => response.json())
        .then(data => {
            if (data.trang_thai === 'thanh_cong') {
                location.reload();
            } else {
                alert('L·ªói t·∫°o d·ª± ƒëo√°n: ' + data.thong_bao);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('L·ªói k·∫øt n·ªëi API');
        });
}

// Model info loader
function tai_thong_tin_mo_hinh() {
    const el = document.getElementById('model_info_content');
    el.textContent = 'ƒêang t·∫£i...';
    fetch('/api/model-info')
        .then(r => r.json())
        .then(d => {
            if (d.trang_thai !== 'thanh_cong') { el.textContent = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin m√¥ h√¨nh'; return; }
            const info = d.thong_tin || {};
            if (!info.available) { el.innerHTML = '<div class="alert alert-warning">Kh√¥ng t√¨m th·∫•y m√¥ h√¨nh production. ƒêang d√πng ch·∫ø ƒë·ªô demo.</div>'; return; }
            let html = [];
            html.push('<div class="alert alert-success py-2">ƒê√£ ph√°t hi·ªán g√≥i m√¥ h√¨nh production.</div>');
            if (info.models && info.models.length) {
                html.push('<p><b>Danh s√°ch m√¥ h√¨nh:</b> ' + info.models.join(', ') + '</p>');
            }
            const perf = info.performance || {};
            if (Object.keys(perf).length) {
                html.push('<h6>Hi·ªáu su·∫•t</h6><ul class="mb-2">');
                for (const k in perf) { html.push(`<li>${k}: ${perf[k]}</li>`); }
                html.push('</ul>');
            }
            const meta = info.metadata || {};
            if (Object.keys(meta).length) {
                html.push('<h6>Metadata</h6><ul class="mb-2">');
                for (const k in meta) { html.push(`<li>${k}: ${meta[k]}</li>`); }
                html.push('</ul>');
            }
            html.push(`<p><b>S·ªë c·ªôt features:</b> ${ (info.feature_cols||[]).length }</p>`);
            el.innerHTML = html.join('
');
        })
        .catch(() => { el.textContent = 'L·ªói khi t·∫£i th√¥ng tin m√¥ h√¨nh'; });
}

// Demo actions
function go_movers() {
    const out = document.getElementById('demo_actions_output');
    out.textContent = 'ƒêang l·∫•y danh s√°ch movers...';
    fetch('/api/movers').then(r=>r.json()).then(d=>{
        if (d.trang_thai !== 'thanh_cong') { out.textContent = 'Kh√¥ng l·∫•y ƒë∆∞·ª£c movers'; return; }
        const g = d.gainers || [], l = d.losers || [];
        out.innerHTML = '<div><b>Top tƒÉng:</b> ' + g.map(x=>`${x.symbol} (${x.change_pct}%)`).join(', ') + '</div>' +
                        '<div><b>Top gi·∫£m:</b> ' + l.map(x=>`${x.symbol} (${x.change_pct}%)`).join(', ') + '</div>';
    }).catch(()=> out.textContent = 'L·ªói l·∫•y movers');
}
function go_price() {
    const out = document.getElementById('demo_actions_output');
    out.textContent = 'ƒêang l·∫•y gi√°...';
    fetch('/api/price?symbol=BTC').then(r=>r.json()).then(d=>{
        out.innerHTML = `<div>BTC hi·ªán t·∫°i: <b>$${d.price}</b> (c·∫≠p nh·∫≠t: ${d.time})</div>`;
    }).catch(()=> out.textContent = 'L·ªói l·∫•y gi√°');
}
function go_chart() {
    const out = document.getElementById('demo_actions_output');
    out.textContent = 'ƒêang l·∫•y link chart...';
    fetch('/api/chart?symbol=BTC').then(r=>r.json()).then(d=>{
        out.innerHTML = `<div>Chart TradingView: <a href="${d.link}" target="_blank">M·ªü chart ${d.symbol}</a></div>`;
    }).catch(()=> out.textContent = 'L·ªói l·∫•y chart');
}

// T·∫£i bi·ªÉu ƒë·ªì gi√°
fetch('/api/bieu-do-gia')
    .then(response => response.json())
    .then(data => {
        if (data.trang_thai === 'thanh_cong') {
            const bieu_do = JSON.parse(data.bieu_do);
            Plotly.newPlot('bieu_do_gia', bieu_do.data, bieu_do.layout);
        }
    });

// T·∫£i bi·ªÉu ƒë·ªì ƒë·ªô tin c·∫≠y
fetch('/api/bieu-do-tin-cay')
    .then(response => response.json())
    .then(data => {
        if (data.trang_thai === 'thanh_cong') {
            const bieu_do = JSON.parse(data.bieu_do);
            Plotly.newPlot('bieu_do_tin_cay', bieu_do.data, bieu_do.layout);
        }
    });

// T·ª± ƒë·ªông refresh m·ªói 30 gi√¢y
setInterval(() => {
    fetch('/api/du-doan-moi');
}, 30000);
</script>
{% endblock %}